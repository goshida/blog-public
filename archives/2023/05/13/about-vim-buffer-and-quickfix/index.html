<!doctype html><html lang=ja><script async src="https://www.googletagmanager.com/gtag/js?id=G-Q4NDL34NBB"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Q4NDL34NBB")</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,minimum-scale=1,user-scalable=yes"><meta http-equiv=refresh content="0; url=https://blog.goshida.net/archives/2023/05/13/about-vim-buffer-and-quickfix/"><title>Vim のバッファと Quickfix 機能について調べたこと - SHIDALOG</title><meta name=author content="goshida"><meta name=description content="Vim のバッファと Quickfix という機能に調べたことのメモ。"><meta name=generator content="Hugo 0.105.0"><meta property="og:title" content="Vim のバッファと Quickfix 機能について調べたこと"><meta property="og:description" content="Vim のバッファと Quickfix という機能に調べたことのメモ。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.shida-ws.net/archives/2023/05/13/about-vim-buffer-and-quickfix/"><meta property="article:section" content="archives"><meta property="article:published_time" content="2023-05-13T00:42:12+09:00"><meta property="article:modified_time" content="2023-05-13T00:42:12+09:00"><link rel=stylesheet href=https://blog.shida-ws.net/css/style.css><link rel=stylesheet href=https://blog.shida-ws.net/css/custom.css><body><div class=site_container><header class=site_header_container><div class="header_container content_area"><div class=header_body><input type=checkbox class=menu_trigger id=menu_trigger><div class=header_main_container><div class=logo_container><div class=site_logo><a href=https://blog.shida-ws.net/>SHIDALOG</a></div><div class=site_tagline>備忘録的なもの</div></div><div class=menu_button_container><label class="menu_button is_icon icon_menu" for=menu_trigger></label></div></div><div class=menu_container><nav class=site_navigation_container><ul class=navigation_list><li class=navigation_item><a href=/archives/>Archives</a></li><li class=navigation_item><a href=/tags/>Tags</a></li><li class=navigation_item><a href=/about/>About</a></li><li class=navigation_item><a href=/policy/>Policy</a></li></ul></nav><div class=social_container><ul class=social_list><li class=social_item><a class="is_icon icon_github" href=https://github.com/goshida></a></li><li class=social_item><a class="is_icon icon_rss" href=/index.xml></a></li></ul></div></div></div></div></header><div class=site_main_container><div class="single_container content_area"><div class=single_main_container itemscope itemtype=https://schema.org/BlogPosting><main class="article_main_container card"><article class=article_container><header class=article_header><h1 class=article_title itemprop=headline>Vim のバッファと Quickfix 機能について調べたこと</h1></header><section class=article_body itemprop=articleBody><p>Vim のバッファと Quickfix という機能に調べたことのメモ。</p><p>記事の中身は Vim の基本的な操作の話なので、
「Vim 初心者がなんか躓いたことの記録」くらいのつもりで読んで貰えればと思う。</p><h2 id=背景>背景</h2><p>最近時間が余っていることもあって、 <a href=https://atcoder.jp/>AtCoder</a> を触っている。
プログラミングからだいぶ離れていたこともありアルゴリズム以前の部分で引っかかることも多く、正直 ABC の C 問題を正答できるかすら怪しいというレベルではあるが、
学生時代のプログラミングの講義の気分を思い出しつつそれなりに楽しんでいる。</p><p>とまぁ競プロに関する話は一旦置いといて、コードを書く環境はエディタに Neovim 、言語は Python を使っている。
で、テストにはこんな感じの Makefile を書いて Neovim から <code>:make test1</code> する感じでテストしつつコードを書いている。</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Makefile data-lang=Makefile><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>test1</span><span style=color:#ff7b72;font-weight:700>:</span>
</span></span><span style=display:flex><span>	python answer.py &lt; input/test1
</span></span></code></pre></div><p>ただ、これでエラーが出た場合に空のファイルが開いているような感じになるのだが、それがどういう状況なのかがよく分からず、
編集中のファイルへの戻り方も分からなかったのでとりあえず <code>:q!</code> で Vim ごと閉じてファイルを開き直すという微妙なことをやっていた。</p><p>実際の画面としてはこんな感じ</p><figure><a href=/archives/2023/05/13/about-vim-buffer-and-quickfix/images/nvim-make-1.webp target=_self><img src=/archives/2023/05/13/about-vim-buffer-and-quickfix/images/nvim-make-1.webp alt=makeでエラーが発生したときの例></a><figcaption>:make test1 してこんな感じでエラーが出たとして</figcaption></figure><figure><a href=/archives/2023/05/13/about-vim-buffer-and-quickfix/images/nvim-make-2.webp target=_self><img src=/archives/2023/05/13/about-vim-buffer-and-quickfix/images/nvim-make-2.webp alt=makeのエラーから続けたときの例></a><figcaption>Enterなり入力して続けるとこうなる</figcaption></figure><p>で、これがどういう状況なのかも分からないのでググるにしてもキーワードの検討が付かなかったのだが、
ChatGPT と少し問答したところ Vim に Quickfix という機能があってそれによって別のバッファに切り替わっているっぽいというヒントを得たので調べた。</p><p>というのが今回の背景。</p><h2 id=vim-におけるバッファについて>Vim におけるバッファについて</h2><p>まず Vim のバッファに関する基本的な概念、操作について簡単にまとめて、今回の場合どうすれば良かったかについて触れる。</p><h3 id=バッファの基本的な概念>バッファの基本的な概念</h3><p>Vim でファイルを操作する場合、</p><ul><li>ファイルの中身を一旦メモリ上に展開して</li><li>そのメモリ上の領域に対して操作を行い</li><li><code>:w</code> 等で保存操作を行った時にファイル実体への反映を行う</li></ul><p>という感じのことをやっている。 <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><p>そのファイルの中身を展開したメモリ上の領域１つ１つを Vim ではバッファと呼んでいる。
またファイルに紐付かない状態でバッファが作られることもある。</p><p>具体的な例として</p><ul><li>シェルから <code>vim</code> とかでファイルを指定せず Vim を起動した場合、ファイルに紐付いてない空のバッファが開いた状態で Vim が起動している。</li><li>シェルから <code>vim hoge.txt fuga.txt</code> とかで複数のファイルを指定して起動した場合、複数のファイルそれぞれを別のバッファに開いた状態で Vim が起動している。</li><li>Vim で、あるファイルを編集している最中に <code>:e .</code> とかで別のファイルを開いた場合、編集中だったバッファはそのままで新しいバッファに別のファイルの中身を展開して表示している。</li></ul><p>みたいな感じ。</p><p>なので、バッファを意識してるしてないに関わらず Vim を使っている間はあらゆる場面でバッファに対して操作を行っている。</p><h3 id=バッファ操作コマンドのまとめ>バッファ操作コマンドのまとめ</h3><p>バッファ周りの基本的な操作コマンドについてまとめる。</p><p>詳しいことはヘルプに書いているので各コマンドのヘルプを見れば良いのだが、
いきなり全部は覚えられなそうなのとあまり頻繁に help 開いてると面倒になって使わなくなりそうな気がしたので、
ひとまず覚えられそうな範囲かつ基本的な操作に困らなさそうな程度に書き下しておく。</p><table><thead><tr><th>コマンド</th><th>省略形</th><th>内容</th></tr></thead><tbody><tr><td>:ls</td><td>-</td><td>バッファリストを表示する</td></tr><tr><td>:buffer [N]</td><td>:b [N]</td><td>N番のバッファに切り替え（N省略時はカレントバッファ、つまり何もしない）</td></tr><tr><td>:bnext [N]</td><td>:bn [N]</td><td>N個後のバッファに切り替え（省略時のNは1）</td></tr><tr><td>:bprevious [N]</td><td>:bp [N]</td><td>N個前のバッファに切り替え（省略時のNは1）</td></tr><tr><td>:bfirst</td><td>:bf</td><td>1番目のバッファに切り替え</td></tr><tr><td>:blast</td><td>:bl</td><td>最後のバッファに切り替え</td></tr><tr><td>:bdelete [N]</td><td>:bd [N]</td><td>N番のバッファをバッファリストから削除する（N省略時はカレントバッファ）、バッファ自体は残る</td></tr><tr><td>:bwipeout [N1 N2 &mldr;]</td><td>:bw [N1 N2 &mldr;]</td><td>N1, N2, &mldr; のバッファを削除する（N省略時はカレントバッファ）</td></tr></tbody></table><p>それぞれのコマンドには別の指定方法があったりするが、今回は省略（各コマンドのヘルプ参照）</p><h4 id=ls>:ls</h4><p>また、 <code>:ls</code> の見方について少し補足。</p><p>Vim のヘルプからの転記にはなるが、実際の出力としてはこんな感じになる。</p><pre tabindex=0><code>                        1 #h   &#34;/test/text&#34;             line 1
                        2u     &#34;asdf&#34;                   line 0
                        3 %a + &#34;version.c&#34;              line 1
</code></pre><p>これの見方もヘルプに詳細を書いているが、</p><ul><li>一番左の数字がバッファの番号</li><li>その右の謎の文字列がバッファの状態を示すフラグ群</li><li>更に右のダブルクォートで囲まれた部分がバッファの名前</li><li>一番右がバッファで現在フォーカスしている行</li></ul><p>という感じになっている。</p><p>フラグについて、よく見かけそうなものをピックアップすると以下あたり。</p><table><thead><tr><th>flag</th><th>意味</th></tr></thead><tbody><tr><td>u</td><td>:bd で閉じたバッファ（ :ls! すると閉じたバッファも表示する）</td></tr><tr><td>#</td><td>代替バッファ（大抵の場合直前に開いていたバッファ）</td></tr><tr><td>%</td><td>現在フォーカスしているウィンドウに表示しているバッファ</td></tr><tr><td>a</td><td>どこかのウィンドウに表示されているバッファ</td></tr><tr><td>h</td><td>どのウィンドウにも表示されていないバッファ</td></tr><tr><td>-</td><td>modifiable が off に設定されているバッファ （プラグインとかが使うバッファでよく見るらしい） <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></td></tr><tr><td>=</td><td>ReadOnly なバッファ（変更権限の無いファイルを開いた時とか、 <code>vim -R</code> で起動した時等） <sup id=fnref1:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></td></tr><tr><td>+</td><td>ファイルに反映されてない変更を含むバッファ</td></tr></tbody></table><h3 id=冒頭のケース>冒頭のケース</h3><p>ということで、ここまでを理解した上で冒頭の話に戻ると、Vim で <code>:make test1</code> してエラーが発生した状態から、 <code>:ls</code> でバッファリストを確認すると以下の様な感じになる。</p><figure><a href=/archives/2023/05/13/about-vim-buffer-and-quickfix/images/nvim-make-3.webp target=_self><img src=/archives/2023/05/13/about-vim-buffer-and-quickfix/images/nvim-make-3.webp alt="makeでエラーが発生した上体で :ls コマンドを使った画面"></a></figure><p>なので単純に <code>make: *** [Makefile</code> という名前のバッファを <code>:bd</code> や <code>:bw</code> で消したり、 <code>:bn</code> や <code>:bp</code> 等で元のファイルを開いているバッファに戻ればよかった、
ということが分かる。</p><h2 id=quickfix-機能について>Quickfix 機能について</h2><p>ここからはそもそも何故別のバッファが開いて、それに切り替わったのかという部分になる。</p><h3 id=quickfix-の概要>Quickfix の概要</h3><p>まずは Quickfix という機能の概要から。</p><p>例によって詳細は Vim のドキュメント参照ではあるが、
自分の事前理解が足りてないのか分かりにくかったので自分の言葉で書き下してみる。</p><ul><li><a href=https://vim-jp.org/vimdoc-ja/quickfix.html>quickfix - Vim日本語ドキュメント</a></li></ul><p>この機能はもともと編集、コンパイル、編集という開発サイクルの中で、
「コンパイル時に発生したエラーを Vim の画面から素早く確認して修正作業に反映する」という部分のサポートを目的とした機能になる。
とある C コンパイラにあった機能を参考にして作られたものらしい。</p><p>もう少し具体的には、編集と編集の間に発生する</p><ul><li>ファイルの保存</li><li>コンパイル処理の実行</li><li>エラーメッセージの検出とユーザへの表示</li></ul><p>等の処理をある程度自動化するための機能で、この一連の処理は Vim の <code>:make</code> コマンドにより呼び出すことができる。</p><p>ただ、Quickfix はこういった目的で作られた機能ではあるが、
単純に Quickfix と言うと特に3つ目の部分を指していることが多い。
というのも、コンパイル時に発生したエラーメッセージの確認をサポートする部分は「テキストファイル内の位置（行、列）のリストを作成しジャンプする」という形で実現されているのだが、
これは単純な Vim で文字列検索（ vimgrep ）をする場面でも便利で、そういった目的でもよく使われているためと思われる。</p><p>というのが Quickfix という機能（群？）のざっくりした概要になる。</p><h3 id=make-について>:make について</h3><p>この Quickfix の一連の処理を呼び出す <code>:make</code> コマンドについて。</p><p>これは Vim から外部コマンドである <code>make</code> コマンド（ Makefile を使うアレ）を直接実行しているわけでは無くて、 <strong>Vim の</strong> <code>:make</code> コマンドになる。
（混乱しそうなので Makefile を使うアレを <code>make</code> 、 Vim の make コマンドを <code>:make</code> と統一する）</p><p><code>:make</code> が行う処理の内容は Vim のドキュメントの中の make の項に書いてある。
そのまま引用するとこんな感じ。</p><blockquote><p><a href=https://vim-jp.org/vimdoc-ja/quickfix.html#:make_makeprg>quickfix - Vim日本語ドキュメント</a></p><ol><li>QuickFixCmdPre に関連付けられた自動コマンドが全て実行される</li><li>オプション &lsquo;autowrite&rsquo; がonならば変更のあるバッファは保存される。</li><li>&lsquo;makeef&rsquo; からエラーファイルの名前が生成される。
&lsquo;makeef&rsquo; が &ldquo;##&rdquo; を含まずかつ既に名前が存在する場合
それは削除される。</li><li>オプション &lsquo;makeprg&rsquo; で与えられたプログラム (省略時
&ldquo;make&rdquo;) が [argument]をオプションにして実行され、出
力がerrorfileに保存される (Unixではそれも画面にecho
される)。</li><li>&rsquo;errorformat&rsquo; を使ってerrorfileが読みこまれる。</li><li>QuickFixCmdPost に関連付けられた自動コマンドが全
て実行される。後述のサンプルを参照。</li><li>[!]が与えられていないときは最初のエラーに移動する。</li><li>エラーファイルが削除される。</li><li>:cnextや:cprevious などのコマンドでエラー間を移
動できる。上を参照。</li></ol></blockquote><p>今回自分は冒頭で書いたとおり <code>python answer.py &lt; input/test1</code> という処理を実行するために Makefile を書いて、
Vim から <code>:make test1</code> と実行していたのだが、これは前述したとおり <code>make</code> ではなく <code>:make</code> である。
そのため上記の諸々の処理が実行されていたのだが、
上記引用の 4 に書いている通り <code>:make</code> 実行時の makeprg を省略する形になっていたことで <code>make</code> が実行されるので、
結果的に意図したコマンド <code>make test1</code> が実行されているように見えていた、ということになる。 <sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup></p><h3 id=冒頭のケース-1>冒頭のケース</h3><p>と、ここまでで分かった通り、意図せず Quickfix 機能を使って <code>:make</code> 経由で <code>make</code> を実行していたことが原因なので、
ちゃんと Vim から <code>:!make test1</code> と外部コマンドとして <code>make</code> を実行することで、そもそもバッファが切り替わったりすることもなくなった。</p><p><code>:make</code> がエラーメッセージを拾ってバッファを切り替えるまでの仕組みを追うという意味で errorformat 周りを少し調べたりはしたのだが、
理解するまでに結構な時間がかかりそうだったのでこっちは見送った。
もう少し Vim の経験値がたまったら Quickfix 辺りは改めて調べたい。</p><h2 id=感想>感想</h2><p>Vim の基本的な操作（バッファなり外部コマンドなり）をちゃんと理解してれば、
冒頭で書いた様な状況でも全部閉じて開き直すパワープレイをしなくてもちゃんと対応できる。</p><p>今まで Vim についてちゃんと使い方を勉強したりはしてなくて、経験上必要になった操作を組み合わせた要するに雰囲気で使ってたのだが、
今回ドキュメントを色々眺めていて操作方法のチュートリアルのようなものも見つけたので、一通りやってみても良いかもなと思った。</p><ul><li><a href=https://vim-jp.org/vimdoc-ja/usr_toc.html>usr_toc - Vim日本語ドキュメント</a></li></ul><h2 id=参考>参考</h2><ul><li><a href=https://zenn.dev/sa2knight/articles/e0a1b2ee30e9ec22dea9>vim バッファ入門</a></li><li><a href=https://tyru.hatenablog.com/entry/20101107/modifiable_and_readonly>modifiableとreadonlyの違い - Humanity</a></li><li><a href=https://vim-jp.org/vimdoc-ja/quickfix.html>quickfix - Vim日本語ドキュメント</a></li><li><a href=https://zenn.dev/tmrekk/articles/4380961a754287>Vim初心者のQuickfixによる検索・置換入門</a></li><li><a href=https://qiita.com/rbtnn/items/92f80d53803ce756b4b8>errorformatについて(入門編) - Qiita</a></li></ul><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Vim というか大抵のプログラムは基本そうだとは思うが。&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://tyru.hatenablog.com/entry/20101107/modifiable_and_readonly>modifiableとreadonlyの違い - Humanity</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a>&#160;<a href=#fnref1:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>一応外部コマンド実行時は <code>:!〜〜</code> という形式であることは認識していたのだが、 <code>make</code> で期待した出力はされていたので「 <code>!</code> 無いけどなんか動いてるからヨシ！」となっていたんだと思う。&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></section></article></main><aside class=article_aside_container><div class="article_meta_container card"><dl class=article_meta_list><div class="article_meta_item title"><dt class=article_meta_key><span>Title</span></dt><dd class=article_meta_value>Vim のバッファと Quickfix 機能について調べたこと</dd></div><div class="article_meta_item timestamp"><dt class="article_meta_key has_icon icon_calendar"><span>Published</span></dt><dd class=article_meta_value><time class=published_date itemprop=datePublished datetime=2023-05-13T00:42:12+09:00>2023-05-13</time></dd></div><div class="article_meta_item taxonomy"><dt class="article_meta_key has_icon icon_tag"><span>Tags</span></dt><dd class=article_meta_value><ul class=taxonomy_list><li class=taxonomy_list_item><a class=taxonomy_button href=https://blog.shida-ws.net/tags/neovim/>Neovim</a></li></ul></dd></div></dl></div><div class="article_toc_container card"><div class=article_toc><div class=toc_header>Table of contents</div><div class=toc_body><nav id=TableOfContents><ul><li><a href=#背景>背景</a></li><li><a href=#vim-におけるバッファについて>Vim におけるバッファについて</a><ul><li><a href=#バッファの基本的な概念>バッファの基本的な概念</a></li><li><a href=#バッファ操作コマンドのまとめ>バッファ操作コマンドのまとめ</a></li><li><a href=#冒頭のケース>冒頭のケース</a></li></ul></li><li><a href=#quickfix-機能について>Quickfix 機能について</a><ul><li><a href=#quickfix-の概要>Quickfix の概要</a></li><li><a href=#make-について>:make について</a></li><li><a href=#冒頭のケース-1>冒頭のケース</a></li></ul></li><li><a href=#感想>感想</a></li><li><a href=#参考>参考</a></li></ul></nav></div></div></div></aside></div></div></div><footer class=site_footer_container><div class="footer_container content_area"><div class=footer_body>© 2022 shida.
Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and
<a href=https://github.com/goshida/hugo-theme/ rel="nofollow noopener" target=_blank>goshida/hugo-theme</a>.</div></div></footer></div></body></html>