<!doctype html><html lang=ja><script async src="https://www.googletagmanager.com/gtag/js?id=G-Q4NDL34NBB"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Q4NDL34NBB")</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,minimum-scale=1,user-scalable=yes"><title>XKB の設定で capslock を ctrl として使えるようにする - SHIDALOG</title><meta name=author content="goshida"><meta name=description content="CapsLock を Ctrl として使える様にするための設定方法を変えたのでそのメモ。"><meta name=generator content="Hugo 0.105.0"><meta property="og:title" content="XKB の設定で capslock を ctrl として使えるようにする"><meta property="og:description" content="CapsLock を Ctrl として使える様にするための設定方法を変えたのでそのメモ。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.shida-ws.net/archives/2022/11/18/capslock-as-ctrl-in-xkb-configuration/"><meta property="article:section" content="archives"><meta property="article:published_time" content="2022-11-18T03:11:07+09:00"><meta property="article:modified_time" content="2022-12-17T09:27:23+09:00"><link rel=stylesheet href=https://blog.shida-ws.net/css/style.css><link rel=stylesheet href=https://blog.shida-ws.net/css/custom.css><body><div class=site_container><header class=site_header_container><div class="header_container content_area"><div class=header_body><input type=checkbox class=menu_trigger id=menu_trigger><div class=header_main_container><div class=logo_container><div class=site_logo><a href=https://blog.shida-ws.net/>SHIDALOG</a></div><div class=site_tagline>備忘録的なもの</div></div><div class=menu_button_container><label class="menu_button is_icon icon_menu" for=menu_trigger></label></div></div><div class=menu_container><nav class=site_navigation_container><ul class=navigation_list><li class=navigation_item><a href=/archives/>Archives</a></li><li class=navigation_item><a href=/tags/>Tags</a></li><li class=navigation_item><a href=/about/>About</a></li><li class=navigation_item><a href=/policy/>Policy</a></li></ul></nav><div class=social_container><ul class=social_list><li class=social_item><a class="is_icon icon_github" href=https://github.com/goshida></a></li><li class=social_item><a class="is_icon icon_rss" href=/index.xml></a></li></ul></div></div></div></div></header><div class=site_main_container><div class="single_container content_area"><div class=single_main_container itemscope itemtype=https://schema.org/BlogPosting><main class="article_main_container card"><article class=article_container><header class=article_header><h1 class=article_title itemprop=headline>XKB の設定で capslock を ctrl として使えるようにする</h1></header><section class=article_body itemprop=articleBody><p>CapsLock を Ctrl として使える様にするための設定方法を変えたのでそのメモ。</p><p>自分の場合は入れ替えでは無く単純に CapsLock を Ctrl に置き換えたい派。</p><h2 id=まとめ>まとめ</h2><p>以下コマンドで設定した。</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>localectl --no-convert set-x11-keymap us pc104 <span style=color:#a5d6ff>&#34;&#34;</span> ctrl:nocaps
</span></span></code></pre></div><h2 id=背景>背景</h2><p>もともとは CapsLock を Ctrl として動作させるため、 <code>.Xmodmap</code> で以下の様に設定して使っていた。</p><pre tabindex=0><code class=language-text:.Xmodmap data-lang=text:.Xmodmap>clear lock
clear control
keycode 66 = Control_L
add control = Control_L Control_R
</code></pre><p>ただ、自分はキーボードを USB 切替器経由で使っている（PC2台で共有している）のだが、
接続先PCを切り替えたタイミングで上記の設定が効かなくなり若干不便していた。</p><p>軽く調べたところ XKB (X KeyBoard extention) の設定を変更する形で解消しそうだったので、その方法で再設定した。</p><ul><li><a href=https://running-dog.net/2013/08/post_560.html>xmodmap と setxkbmap。 » かけまわる子犬。</a></li></ul><h2 id=設定>設定</h2><p>設定は ArchWiki を参考にしてるので、詳細はそちらを見てもらうのが良さげ。<br>やったこと自体は冒頭のコマンド一発という話ではあるが、自分で忘れそうと思った部分や関連して調べたことなどをメモとして残す。</p><ul><li><a href=https://wiki.archlinux.jp/index.php/X_KeyBoard_extension>X KeyBoard extension - ArchWiki</a></li><li><a href=https://wiki.archlinux.jp/index.php/Xorg_%E3%81%A7%E3%81%AE%E3%82%AD%E3%83%BC%E3%83%9C%E3%83%BC%E3%83%89%E8%A8%AD%E5%AE%9A>Xorg でのキーボード設定 - ArchWiki</a></li></ul><p>まずコマンドの使い方としてはArchWiki にある通りこう</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>localectl <span style=color:#ff7b72;font-weight:700>[</span>--no-convert<span style=color:#ff7b72;font-weight:700>]</span> set-x11-keymap layout <span style=color:#ff7b72;font-weight:700>[</span>model <span style=color:#ff7b72;font-weight:700>[</span>variant <span style=color:#ff7b72;font-weight:700>[</span>options<span style=color:#ff7b72;font-weight:700>]]]</span>
</span></span></code></pre></div><p>それぞれのパラメータの補足としては以下</p><ul><li>&ndash;no-convert<ul><li>これを指定するとコンソール環境には反映されない、 X 環境にのみ設定したい場合はこのオプションを指定する</li><li>コンソールのキーマップを設定したい場合は <code>localectl set-keymap</code> サブコマンドが別途存在する<ul><li>ただこっちはレイアウト（JIS配列とかUS配列とか）くらいしか設定できなさそうではあった<ul><li>今回の <code>ctrl:nocaps</code> のように個別のキーの設定みたいなことはできなさそう</li></ul></li></ul></li></ul></li><li>layout<ul><li><code>localectl list-x11-keymap-layouts</code> からの選択式</li><li>眺めれば分かるがレイアウトと言いつつほぼ言語指定（国コード）<ul><li><code>custom</code> と言うのもあるらしい（自作キーボードとかで使うんだろうか）</li></ul></li></ul></li><li>model<ul><li><code>localectl list-x11-keymap-models</code> からの選択式</li><li>一般的な配列のUSBキーボードを使ってる場合、日本語配列なら <code>pc105</code> 、英語配列なら <code>pc104</code> 辺りにしておけば良さげ</li><li>ラップトップの場合、適切なモデルを選択すれば追加キー（輝度調整とかメディアキーのことだろうか）が使えるようになるらしい<ul><li>（ DELL のラップトップで <code>pc104</code> で設定したが、輝度調整とかのキーも問題無く効いてるので何か理解が間違ってるかもしれない）</li></ul></li></ul></li><li>variant<ul><li><code>localectl list-x11-keymap-variants</code> からの選択式</li><li>同じ言語でもキーのレイアウトに差がある場合があって、それらを variant と呼ぶっぽい<ul><li>ArchWiki の方にも書いてある qwerty 、 dvorak だったり、他にも mac 用キーボードだったり</li></ul></li><li>model とどう違う概念なのかはあんまりピンと来てない</li><li>とりあえずデフォルト指定 <code>""</code> にしておいて、使ってて変なところが見つかれば考えるくらいで良さそう</li></ul></li><li>options<ul><li><code>localectl list-x11-keymap-options</code> からの選択式</li><li>個々のキーの挙動等を指定する</li><li>基本的には予め定義されたプリセットから選ぶ形だが、 XKB の設定をいじることで option を自分で定義することもできるらしい<ul><li><a href=https://junology.hatenablog.com/entry/2017/06/24/141322>Ubuntu で「変換」キーを Shift にする話 (xkb + dconf) - junologyのブログ</a></li></ul></li></ul></li></ul><p>各パラメータの選択肢は上記の通りコマンドでも確認できるが、
<code>/usr/share/X11/xkb/rules/base.lst</code> に説明付きでリストされているので、
最初からそっちを見つつ選ぶでも良さげ。</p><p>ということで、記事の冒頭にあるコマンドを実行すると <code>/etc/X11/xorg.conf.d/00-keyboard.conf</code> に以下のようなファイルが作られ、再起動後に機能するようになる。</p><pre tabindex=0><code class=language-text:/etc/X11/xorg.conf.d/00-keyboard.conf data-lang=text:/etc/X11/xorg.conf.d/00-keyboard.conf># Written by systemd-localed(8), read by systemd-localed and Xorg. It&#39;s
# probably wise not to edit this file manually. Use localectl(1) to
# instruct systemd-localed to update it.
Section &#34;InputClass&#34;
        Identifier &#34;system-keyboard&#34;
        MatchIsKeyboard &#34;on&#34;
        Option &#34;XkbLayout&#34; &#34;us&#34;
        Option &#34;XkbModel&#34; &#34;pc104&#34;
        Option &#34;XkbOptions&#34; &#34;ctrl:nocaps&#34;
EndSection
</code></pre><h2 id=確認>確認</h2><p>設定が効いてるかどうかは実際に CapsLock キー使えば分かるという話ではあるが、一応 <code>xev</code> というコマンドでも確認できる。</p><p>xev ( X EVent の略？) は自身が認識した X のイベントを表示するアプリケーションで、
キー入力であれば押した時、離した時、GUI ウィンドウ上でのカーソルの移動とかも逐一表示する。</p><p>まず自分が使っているキーボードの場合、左 Ctrl を入力した場合はこんな感じ。</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>KeyPress event, serial 37, synthetic NO, window 0x4a00001,
</span></span><span style=display:flex><span>    root 0x559, subw 0x0, time 17575768, <span style=color:#ff7b72;font-weight:700>(</span>-94,290<span style=color:#ff7b72;font-weight:700>)</span>, root:<span style=color:#ff7b72;font-weight:700>(</span>1737,1309<span style=color:#ff7b72;font-weight:700>)</span>,
</span></span><span style=display:flex><span>    state 0x10, keycode <span style=color:#a5d6ff>37</span> <span style=color:#ff7b72;font-weight:700>(</span>keysym 0xffe3, Control_L<span style=color:#ff7b72;font-weight:700>)</span>, same_screen YES,
</span></span><span style=display:flex><span>    XLookupString gives <span style=color:#a5d6ff>0</span> bytes: 
</span></span><span style=display:flex><span>    XmbLookupString gives <span style=color:#a5d6ff>0</span> bytes: 
</span></span><span style=display:flex><span>    XFilterEvent returns: False
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>KeyRelease event, serial 37, synthetic NO, window 0x4a00001,
</span></span><span style=display:flex><span>    root 0x559, subw 0x0, time 17575894, <span style=color:#ff7b72;font-weight:700>(</span>-94,290<span style=color:#ff7b72;font-weight:700>)</span>, root:<span style=color:#ff7b72;font-weight:700>(</span>1737,1309<span style=color:#ff7b72;font-weight:700>)</span>,
</span></span><span style=display:flex><span>    state 0x14, keycode <span style=color:#a5d6ff>37</span> <span style=color:#ff7b72;font-weight:700>(</span>keysym 0xffe3, Control_L<span style=color:#ff7b72;font-weight:700>)</span>, same_screen YES,
</span></span><span style=display:flex><span>    XLookupString gives <span style=color:#a5d6ff>0</span> bytes: 
</span></span><span style=display:flex><span>    XFilterEvent returns: False
</span></span></code></pre></div><p><code>keycode 37</code> が Ctrl キーに対応する keycode で、 <code>keysym 0xffe3, Contrl_L</code> がそれに紐付いた keysym 。<br>また、 Ctrl 含む修飾キーの類が押されていたり CapsLock が効いてるような場合は state が変わる。
（上の例だと KeyPress イベントで <code>state 0x10</code> だったのが KeyRelease 時には <code>state 0x14</code> になっている）</p><p>で、今回の設定後に Caps Lock （ <code>keycode 66</code> ）を押した時の表示が以下。<br>keysym が上記と同じ <code>keysym 0xffe3, Control_L</code> になっていて、 state も Ctrl を押した時と同じ動きをしているのが確認できる。<br>（USB切替器で切り替えて設定が維持されているのも確認した）</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>KeyPress event, serial 36, synthetic NO, window 0x3600001,
</span></span><span style=display:flex><span>    root 0x559, subw 0x0, time 20663183, <span style=color:#ff7b72;font-weight:700>(</span>432,-158<span style=color:#ff7b72;font-weight:700>)</span>, root:<span style=color:#ff7b72;font-weight:700>(</span>2263,861<span style=color:#ff7b72;font-weight:700>)</span>,
</span></span><span style=display:flex><span>    state 0x10, keycode <span style=color:#a5d6ff>66</span> <span style=color:#ff7b72;font-weight:700>(</span>keysym 0xffe3, Control_L<span style=color:#ff7b72;font-weight:700>)</span>, same_screen YES,
</span></span><span style=display:flex><span>    XKeysymToKeycode returns keycode: <span style=color:#a5d6ff>37</span>
</span></span><span style=display:flex><span>    XLookupString gives <span style=color:#a5d6ff>0</span> bytes: 
</span></span><span style=display:flex><span>    XmbLookupString gives <span style=color:#a5d6ff>0</span> bytes: 
</span></span><span style=display:flex><span>    XFilterEvent returns: False
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>KeyRelease event, serial 36, synthetic NO, window 0x3600001,
</span></span><span style=display:flex><span>    root 0x559, subw 0x0, time 20663261, <span style=color:#ff7b72;font-weight:700>(</span>432,-158<span style=color:#ff7b72;font-weight:700>)</span>, root:<span style=color:#ff7b72;font-weight:700>(</span>2263,861<span style=color:#ff7b72;font-weight:700>)</span>,
</span></span><span style=display:flex><span>    state 0x14, keycode <span style=color:#a5d6ff>66</span> <span style=color:#ff7b72;font-weight:700>(</span>keysym 0xffe3, Control_L<span style=color:#ff7b72;font-weight:700>)</span>, same_screen YES,
</span></span><span style=display:flex><span>    XKeysymToKeycode returns keycode: <span style=color:#a5d6ff>37</span>
</span></span><span style=display:flex><span>    XLookupString gives <span style=color:#a5d6ff>0</span> bytes: 
</span></span><span style=display:flex><span>    XFilterEvent returns: False
</span></span></code></pre></div><p>ちなみに設定前の Caps Lock は以下のような感じだった。</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>KeyPress event, serial 37, synthetic NO, window 0x4a00001,
</span></span><span style=display:flex><span>    root 0x559, subw 0x0, time 17261640, <span style=color:#ff7b72;font-weight:700>(</span>-1013,822<span style=color:#ff7b72;font-weight:700>)</span>, root:<span style=color:#ff7b72;font-weight:700>(</span>818,1841<span style=color:#ff7b72;font-weight:700>)</span>,
</span></span><span style=display:flex><span>    state 0x10, keycode <span style=color:#a5d6ff>66</span> <span style=color:#ff7b72;font-weight:700>(</span>keysym 0xffe5, Caps_Lock<span style=color:#ff7b72;font-weight:700>)</span>, same_screen YES,
</span></span><span style=display:flex><span>    XLookupString gives <span style=color:#a5d6ff>0</span> bytes: 
</span></span><span style=display:flex><span>    XmbLookupString gives <span style=color:#a5d6ff>0</span> bytes: 
</span></span><span style=display:flex><span>    XFilterEvent returns: False
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>KeyRelease event, serial 37, synthetic NO, window 0x4a00001,
</span></span><span style=display:flex><span>    root 0x559, subw 0x0, time 17261750, <span style=color:#ff7b72;font-weight:700>(</span>-1013,822<span style=color:#ff7b72;font-weight:700>)</span>, root:<span style=color:#ff7b72;font-weight:700>(</span>818,1841<span style=color:#ff7b72;font-weight:700>)</span>,
</span></span><span style=display:flex><span>    state 0x12, keycode <span style=color:#a5d6ff>66</span> <span style=color:#ff7b72;font-weight:700>(</span>keysym 0xffe5, Caps_Lock<span style=color:#ff7b72;font-weight:700>)</span>, same_screen YES,
</span></span><span style=display:flex><span>    XLookupString gives <span style=color:#a5d6ff>0</span> bytes: 
</span></span><span style=display:flex><span>    XFilterEvent returns: False
</span></span></code></pre></div><p>あと長くなるので <code>xev</code> の出力は省略するが、
<code>a</code> -> <code>CapsLock</code> -> <code>a</code> -> <code>CapsLock</code> -> <code>a</code> とかやると state の動きが ctrl や shift と違うのがよく分かる。</p><h2 id=その他の設定方法>その他の設定方法</h2><p>今回使った方法以外にも設定方法としては色々あり、調べた感じ少なくとも以下の方法があることは認識した。</p><ol><li><code>.Xmodmap</code> で設定するパターン<ul><li>もともと使っていたやつ</li><li>xmodmap という XKB とは独立した仕組みで X におけるキーマップを変更する</li><li>システムなりユーザなりの xinitrc の中で <code>xmodmap ~/.Xmodmap</code> みたいな形で呼ばれて反映されている</li></ul></li><li>X サーバの設定ファイルを弄るパターン<ul><li>今回使ったやつ</li><li>キーボードの入力管理する XKB の設定を変更する形</li><li><code>/etc/X11/xorg.conf.d/</code> にファイルを直接作る派と <code>localectl</code> で生成する派が居る模様</li></ul></li><li>実行中の XKB の設定を変更するパターン<ul><li>コマンドを使って実行中の XKB の設定設定を変更する形</li><li><code>setxkbmap</code> を使ってオプションを指定する形で変更する方法と、 <code>xkbcomp</code> を使ってキーマップをダンプ/ロードする方法があるっぽい<ul><li>ただ ArchWiki の記載を見る限り <code>xkbcomp</code> でのキーマップを弄る方法は非推奨っぽい</li></ul></li><li>どちらも実行中の XKB に対する操作で実行したセッション中しか効かないので、永続化させたい場合は <code>.xinitrc</code> <code>.profile</code> 辺りに追記する</li></ul></li><li>GNOME の設定を使うパターン<ul><li>デスクトップ環境として GNOME を使っている場合 dconf の中で xkb-options というパラメータを持っているので、GUI もしくは <code>gsettings</code> <code>dconf</code> コマンドを使って指定する</li><li>XKBOPTIONS という環境変数での指定もできるっぽい</li></ul></li><li><code>dumpkeys</code> , <code>loadkeys</code> を使うパターン<ul><li>カーネルで持ってる keymap のテーブルを変更する形？（理解が怪しい）</li><li>見かけた限りではコンソール環境でも効いてほしいって人が使ってた印象</li></ul></li></ol><p>2, 3, 4 に関しては設定方法が違うだけで XKB に手を加えるモノなのでまとめても良い気はするが、
何にせよ色んな設定方法があるなぁという印象。</p><p>ユーザ設定（ dotfiles ）として管理するなら 3 の方法でも良い気はしたが、
使っているキーボード（ハードウェア構成）に依存する設定というイメージでシステム設定かな、ということで今回は 2 の方法を取った。</p><h2 id=参考リンク>参考リンク</h2><ul><li><a href=https://wiki.archlinux.jp/index.php/X_KeyBoard_extension>X KeyBoard extension - ArchWiki</a></li><li><a href=https://wiki.archlinux.jp/index.php/Xorg_%E3%81%A7%E3%81%AE%E3%82%AD%E3%83%BC%E3%83%9C%E3%83%BC%E3%83%89%E8%A8%AD%E5%AE%9A>Xorg でのキーボード設定 - ArchWiki</a></li><li><a href=https://wiki.archlinux.jp/index.php/Xmodmap>xmodmap - ArchWiki</a></li><li><a href=https://running-dog.net/2013/08/post_560.html>xmodmap と setxkbmap。 » かけまわる子犬。</a></li><li><a href=https://lambdalisue.hatenablog.com/entry/2013/09/27/212118>CapsLockをCtrlにするまとめ - Λlisue&rsquo;s blog</a></li><li><a href=https://junology.hatenablog.com/entry/2017/06/24/141322>Ubuntu で「変換」キーを Shift にする話 (xkb + dconf) - junologyのブログ</a></li></ul></section></article></main><aside class=article_aside_container><div class="article_meta_container card"><dl class=article_meta_list><div class="article_meta_item title"><dt class=article_meta_key><span>Title</span></dt><dd class=article_meta_value>XKB の設定で capslock を ctrl として使えるようにする</dd></div><div class="article_meta_item timestamp"><dt class="article_meta_key has_icon icon_calendar"><span>Published</span></dt><dd class=article_meta_value><time class=published_date itemprop=datePublished datetime=2022-11-18T03:11:07+09:00>2022-11-18</time></dd></div><div class="article_meta_item timestamp"><dt class="article_meta_key has_icon icon_reload"><span>Modified</span></dt><dd class=article_meta_value><time class=modified_date itemprop=dateModified datetime=2022-12-17T09:27:23+09:00>2022-12-17</time></dd></div><div class="article_meta_item taxonomy"><dt class="article_meta_key has_icon icon_tag"><span>Tags</span></dt><dd class=article_meta_value><ul class=taxonomy_list><li class=taxonomy_list_item><a class=taxonomy_button href=https://blog.shida-ws.net/tags/linux/>Linux</a></li></ul></dd></div></dl></div><div class="article_toc_container card"><div class=article_toc><div class=toc_header>Table of contents</div><div class=toc_body><nav id=TableOfContents><ul><li><a href=#まとめ>まとめ</a></li><li><a href=#背景>背景</a></li><li><a href=#設定>設定</a></li><li><a href=#確認>確認</a></li><li><a href=#その他の設定方法>その他の設定方法</a></li><li><a href=#参考リンク>参考リンク</a></li></ul></nav></div></div></div></aside></div></div></div><footer class=site_footer_container><div class="footer_container content_area"><div class=footer_body>© 2022 shida.
Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and
<a href=https://github.com/goshida/hugo-theme/ rel="nofollow noopener" target=_blank>goshida/hugo-theme</a>.</div></div></footer></div></body></html>